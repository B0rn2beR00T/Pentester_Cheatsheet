# Протокол SMB

## Поиск сетевых папок SMB. Перечисление шар и файлов

С помощью утилиты smbtree можно обнаружить компьютеры Windows с сетевыми шарами:
~~~bash
sudo smbtree -N
~~~
С помощью утилиты smbclient можно просмотреть имеющиеся на компьютере совместные папки:
~~~bash
sudo smbclient -L \\ИМЯ-КОМПЬЮТЕРА -N
~~~
Также с помощью smbclient, используя команду следующего вида, можно подключиться к сетевой папке и выполнить обычные файловые операции:
~~~bash
sudo smbclient //ИМЯ-КОМПЬЮТЕРА/Папка -N
~~~
В предыдущих двух командах используется опция -N для входа без пароля. Если вы хотите подключиться к папке, требующей аутентификации, то используйте опцию -U после которой укажите имя пользователя, а опцию -N уберите.

Поиск SMB по открытым портам
SMB использует порты 445 и 139, поэтому компьютеры с сетевыми шарами можно искать с помощью Nmap командой вида:
~~~bash
sudo nmap СЕТЬ -p 139,445
~~~
Например:
~~~bash
sudo nmap 192.168.0.0/24 -p 139,445
~~~

### enum4linux

Программа enum4linux задействует инструменты из пакета Samba для сбора информации используя общие папки Windows. Некоторые инструменты пакета Samba рассмотрены во второй части и вы можете применять их напрямую. С помощью enum4linux можно автоматизировать процесс.

Рассмотрим применение самых интересных опций. Во-первых, эта опция -a, которая означает собрать всю возможную информацию:
~~~bash
enum4linux -a 192.168.0.1
~~~
Некоторые системы настроены на анонимный вход, но при этом не разрешают вход без пароля — то есть в них запрещены нулевые сессии. Для обхода этой проблемы достаточно указать любое имя пользователя, пароль можно не указывать. Обратите внимание, что важно указать пользователя, который отсутствует в системе, где размещена общая папка, иначе доступ будет не разрешён из-за неверных учётных данных. Пользователя можно указать опцией -u:
~~~bash
enum4linux -a -u anyuser 192.168.0.101
~~~
Программа enum4linux обычно сама правильно определяет рабочую группу и указывать её вручную не требуется. Но я столкнулся с ситуацией, когда для хоста на Linux, где сетевая папка была настроена с помощью Samba, enum4linux не могла определить рабочую группу и выводила множество ошибок. Для принудительного указания рабочей группы используйте опцию -w:
~~~bash
enum4linux -a -w WORKGROUP 192.168.0.89
~~~
Если вы хотите только получить список совместных папок, то укажите опцию -S вместо -a:
~~~
enum4linux -S -u anyuser 192.168.0.101
~~~
Если вам известен логин и пароль для входа на сетевую папку, то укажите имя пользователя опцией -u, а пароль опцией -p:
~~~bash
enum4linux -S -u ShareOverlord -p 1234 192.168.0.101
~~~
Для получения только списка пользователей, укажите опцию -U, для получения информации об операционной системе используйте опцию -o. Обратите внимание, что опция -a включает эти опции, а в общей сложности она активизирует опции -U -S -G -P -r -o -n -i.
~~~bash
enum4linux -U -o -w WORKGROUP 192.168.0.89
~~~

В характеристике пользователей присутствует ACB — это account control block.

Могут быть следующие значения:
~~~
/* Допустимые контрольные биты учётной записи */
0x00000001  /* 1 = Аккаунт пользователя отключён */
0x00000002  /* 1 = Требуется домашняя директория */
0x00000004  /* 1 = Пользовательский пароль не требуется */
0x00000008  /* 1 = Временный дублирующий аккаунт */
0x00000010  /* 1 = Обычная учётная запись пользователя */
0x00000020  /* 1 = Учётная запись пользователя для входа в систему MNS */
0x00000040  /* 1 = Междоменный доверительный аккаунт */
0x00000080  /* 1 = Доверенная учётная запись рабочей станции */
0x00000100  /* 1 = Доверенный серверный аккаунт (BDC) */
0x00000200  /* 1 = Пользовательский пароль не истёк */
0x00000400  /* 1 = Аккаунт заблокирован автоматически */
 
/* действительны только для > Windows 2000 */
0x00000800  /* 1 = Текстовый пароль зашифрован */
0x00001000  /* 1 = Требуется Смарт карта */
0x00002000  /* 1 = Доверенный для Делегирования */
0x00004000  /* 1 = Не делегировано */
0x00008000  /* 1 = Использовать только ключ DES */
0x00010000  /* 1 = Preauth (предварительная аутентификация) не требуется */
0x00020000  /* 1 = Пароль истёк */
0x00080000  /* 1 = Данные для авторизации не требуются */
~~~
Для описания пользователя используется сумма битов.

Примеры:

Windows Server:

0x00000210 у Administrator (судя по битам, пароль не истёк, обычный пользователь)
0x00000215 у Guest (судя по битам, пароль не истёк, обычный пользователь, заблокирован)
Windows 10:

0x00000214 у MiAl (судя по битам, обычный пользователь, пароль не требуется — действительно так, учётная запись без пароля)
0x00000214 у Tester (судя по битам, обычный пользователь, пароль не требуется — на самом деле, пароль установлен)

### nullinux
Nullinux, используя SMB, применяется для перечисления информации ОС, информации доменов, общих сетевых папок, директорий и пользователей. Если в аргументах строки команды не указаны имя пользователь и пароль, то пробуется анонимный вход или нулевая сессия. Nullinux является обёрткой для инструментов Samba (smbclient и rpcclient) для перечисления хостов используя различные техники.

nullinux предустановлена в BlackArch. Для установки nullinux в Kali Linux выполните команды: (ссылка на установку в Kali)

sudo apt install python3-pip
git clone https://github.com/m8r0wn/nullinux
cd nullinux
sudo bash setup.sh
nullinux -h

По умолчанию nullinux перечислит пользователей и общие папки для всех указанных хостов. Аргументами командной строки можно настроить процесс перечисления.

Выполнить анонимное подключение, нулевую сессию для хоста (192.168.0.1) с SMB и получить информацию, в том числе сетевые папки и пользователей:

~~~bash
nullinux 192.168.0.1
~~~

Для перечисления информации подключиться к хосту с общей папкой (192.168.0.101) используя известные имя пользователя (-U ShareOverlord) и пароль (-P 1234):

~~~bash
nullinux 192.168.0.101 -U ShareOverlord -P 1234
~~~

Получить список сетевых папок и их содержимого (опция -shares) для списка хостов (192.168.0.89,192.168.0.1,192.168.0.101) используя заведомо несуществующее на них имя пользователя (опция -p anyuser) для анонимного входа на хосты, где не работает вход без имени пользователя:

~~~bash
nullinux 192.168.0.89,192.168.0.1,192.168.0.101 -shares -p anyuser
~~~

### SMB Spider
Чтобы получить содержимое общей сетевой папки укажите опцию -s с именем папки, а хост нужно указать после опции -ip:
~~~bash
smbspider -ip 192.168.0.101 -s Share
~~~
В предыдущем примере будет использоваться нулевая сессия, вход без имени пользователя и пароля, если вам известны имя и пароль для входа, то имя укажите после опции -u, а пароль после -p:

~~~bash
smbspider -ip 192.168.0.101 -s ShareRestricted -u ShareOverlord -p 1234
~~~

# Ресурсы
https://hackware.ru/?p=11040
